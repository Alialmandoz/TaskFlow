# Contenido del Proyecto: TaskFlow

**Generado el:** 2025-05-12 20:57:26

## Estructura del Proyecto

```text
TaskFlow
├── TaskFlowProject
│   ├── __init__.py
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── accounting
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── forms.py
│   ├── migrations
│   │   ├── 0001_initial.py
│   │   └── __init__.py
│   ├── models.py
│   ├── templates
│   │   └── accounting
│   │       └── transaction_form.html
│   ├── tests.py
│   ├── urls.py
│   └── views.py
├── manage.py
└── tasks
    ├── __init__.py
    ├── admin.py
    ├── apps.py
    ├── forms.py
    ├── migrations
    │   ├── 0001_initial.py
    │   └── __init__.py
    ├── models.py
    ├── services.py
    ├── templates
    │   └── tasks
    │       ├── base.html
    │       ├── project_detail.html
    │       ├── project_form.html
    │       ├── project_list.html
    │       └── task_form.html
    ├── tests.py
    ├── urls.py
    └── views.py
```

---

## Archivo: `TaskFlowProject/__init__.py`

```python

```

---

## Archivo: `TaskFlowProject/asgi.py`

```python
"""
ASGI config for TaskFlowProject project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'TaskFlowProject.settings')

application = get_asgi_application()

```

---

## Archivo: `TaskFlowProject/settings.py`

```python
"""
Django settings for TaskFlowProject project.

Generated by 'django-admin startproject' using Django 5.2.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path
from pathlib import Path
import os # <-- Asegúrate de que os esté importado
from dotenv import load_dotenv # <-- Importa load_dotenv

# Carga las variables del archivo .env
load_dotenv() # <-- Llama a la función para cargar las variables

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = '[REDACTED_CREDENTIAL]'

GOOGLE_API_KEY = os.getenv('GOOGLE_API_KEY') # <-- Recupera la clave usando os.getenv()

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'crispy_forms',
    'crispy_bootstrap5',
    'tasks', 
    'accounting',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'TaskFlowProject.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [], # Podríamos añadir rutas aquí para plantillas globales, pero para plantillas de app, APP_DIRS es clave.
        'APP_DIRS': True, # <--- ¡Esto debe ser True!
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]
WSGI_APPLICATION = 'TaskFlowProject.wsgi.application'

# Configuración para django-crispy-forms
CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5" # O "bootstrap4", "tailwind", etc.
CRISPY_TEMPLATE_PACK = "bootstrap5"         # Especifica el pack que quieres usar


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

```

---

## Archivo: `TaskFlowProject/urls.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\TaskFlowProject\urls.py

from django.contrib import admin
from django.urls import path, include # Importamos include

urlpatterns = [
    path('admin/', admin.site.urls), # La URL del sitio de administración que ya usamos
    # Incluimos las URLs de nuestra app tasks bajo la ruta base 'tasks/'
    # Esto significa que las URLs definidas en tasks/urls.py (como 'projects/')
    # serán accesibles en '/tasks/projects/', '/tasks/projects/<int:pk>/', etc.
    path('tasks/', include('tasks.urls')),
    # Puedes añadir una ruta raíz si quieres, por ejemplo:
    path('', include('tasks.urls')), # Esto haría que 'projects/' fuera accesible en '/'
    path('accounting/', include('accounting.urls')),
]
```

---

## Archivo: `TaskFlowProject/wsgi.py`

```python
"""
WSGI config for TaskFlowProject project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'TaskFlowProject.settings')

application = get_wsgi_application()

```

---

## Archivo: `accounting/__init__.py`

```python

```

---

## Archivo: `accounting/admin.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\accounting\admin.py

from django.contrib import admin
from .models import Category, Transaction # Importamos nuestros modelos

@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    """
    Configuración de la administración para el modelo Category.
    """
    list_display = ('name', 'user') # Campos a mostrar en la lista de categorías
    list_filter = ('user',) # Permite filtrar por usuario
    search_fields = ('name', 'user__username') # Permite buscar por nombre de categoría o nombre de usuario
    # Asegura que al crear una categoría desde el admin, el usuario actual se asigne si no es superuser.
    # O mejor aún, que solo el usuario pueda ver/editar sus propias categorías.
    # Esto requiere un poco más de lógica en get_queryset y save_model si queremos una restricción estricta.
    # Por ahora, un superusuario verá todas. Un usuario normal no debería tener acceso al admin
    # a menos que le demos permisos específicos.

    # Para simplificar la creación para el usuario actual, si no es superuser:
    def save_model(self, request, obj, form, change):
        if not obj.pk: # Si es un objeto nuevo
            if not request.user.is_superuser and not hasattr(obj, 'user'): # Si no es superuser y el usuario no está seteado
                obj.user = request.user # Asignar el usuario actual
        super().save_model(request, obj, form, change)

    def get_queryset(self, request):
        qs = super().get_queryset(request)
        if request.user.is_superuser:
            return qs # El superusuario ve todas las categorías
        return qs.filter(user=request.user) # Otros usuarios solo ven sus propias categorías

@admin.register(Transaction)
class TransactionAdmin(admin.ModelAdmin):
    """
    Configuración de la administración para el modelo Transaction.
    """
    list_display = ('description', 'amount', 'transaction_date', 'category', 'project', 'user', 'type')
    list_filter = ('transaction_date', 'user', 'category', 'project', 'type')
    search_fields = ('description', 'notes', 'user__username', 'project__name', 'category__name')
    list_editable = ('amount', 'category') # Campos que se pueden editar directamente en la lista (cuidado con esto)
    date_hierarchy = 'transaction_date' # Añade navegación por fechas
    fieldsets = (
        (None, {
            'fields': ('user', 'description', 'amount', 'type', 'transaction_date')
        }),
        ('Asociaciones', {
            'fields': ('category', 'project')
        }),
        ('Notas Adicionales', {
            'fields': ('notes',),
            'classes': ('collapse',) # Hace esta sección colapsable
        }),
    )

    # Similar a CategoryAdmin, para asignar el usuario automáticamente y filtrar por usuario
    def save_model(self, request, obj, form, change):
        if not obj.pk:
             if not request.user.is_superuser and not hasattr(obj, 'user'):
                obj.user = request.user
        super().save_model(request, obj, form, change)

    def get_queryset(self, request):
        qs = super().get_queryset(request)
        if request.user.is_superuser:
            return qs
        return qs.filter(user=request.user) # Usuarios solo ven sus transacciones
        
    # Para asegurar que los ForeignKeys a Category y Project solo muestren
    # las opciones pertenecientes al usuario actual (si no es superuser)
    def formfield_for_foreignkey(self, db_field, request, **kwargs):
        if not request.user.is_superuser:
            if db_field.name == "category":
                kwargs["queryset"] = Category.objects.filter(user=request.user)
            if db_field.name == "project":
                # Asumiendo que el modelo Project también tiene un campo 'user'
                from tasks.models import Project # Importación local
                kwargs["queryset"] = Project.objects.filter(user=request.user)
        return super().formfield_for_foreignkey(db_field, request, **kwargs)

# Otra forma más simple de registrar si no necesitas personalización:
# admin.site.register(Category)
# admin.site.register(Transaction)
```

---

## Archivo: `accounting/apps.py`

```python
from django.apps import AppConfig


class AccountingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounting'

```

---

## Archivo: `accounting/forms.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\accounting\forms.py

from django import forms
from .models import Transaction, Category # Importamos nuestros modelos de accounting
from tasks.models import Project # Importamos el modelo Project de la app tasks

class TransactionForm(forms.ModelForm):
    """
    Formulario para crear y actualizar Transacciones (gastos).
    """
    # Personalización de campos si es necesario, por ejemplo, para el widget de fecha
    transaction_date = forms.DateField(
        widget=forms.DateInput(attrs={'type': 'date'}), # Usa el input de tipo fecha del navegador
        label="Fecha de la Transacción"
    )

    # Queryset para el campo 'category' y 'project' se ajustará en la vista
    # para mostrar solo las opciones relevantes al usuario.
    category = forms.ModelChoiceField(
        queryset=Category.objects.none(), # Queryset vacío inicialmente, se llenará en la vista
        required=False, # Permitir no categorizar inicialmente
        label="Categoría"
    )
    project = forms.ModelChoiceField(
        queryset=Project.objects.none(), # Queryset vacío inicialmente, se llenará en la vista
        required=False, # Un gasto puede no estar asociado a un proyecto
        label="Proyecto Asociado (Opcional)"
    )

    class Meta:
        model = Transaction
        # Campos que queremos en el formulario
        fields = [
            'description', 
            'amount', 
            'transaction_date', 
            'type', # Aunque sea solo 'expense' por ahora, es bueno tenerlo si se expande
            'category', 
            'project', 
            'notes'
        ]
        # Excluimos 'user' porque se asignará automáticamente en la vista.
        # Excluimos 'created_at' y 'updated_at' porque son automáticos.

        widgets = {
            'notes': forms.Textarea(attrs={'rows': 3}), # Hacer el campo de notas un poco más grande
            'description': forms.TextInput(attrs={'placeholder': 'Ej: Almuerzo con cliente, Compra de software'}),
            'amount': forms.NumberInput(attrs={'placeholder': 'Ej: 25.50'}),
        }
        labels = {
            'description': 'Descripción del Gasto',
            'amount': 'Monto ($)', # Puedes ajustar la moneda o hacerlo dinámico
            'type': 'Tipo de Transacción',
            'notes': 'Notas Adicionales',
        }
        help_texts = {
            'type': 'Actualmente solo se registran gastos.',
        }

    def __init__(self, *args, **kwargs):
        # Es crucial obtener el 'user' aquí para filtrar los querysets de category y project.
        # La vista pasará el usuario al instanciar el formulario.
        user = kwargs.pop('user', None) # Extraemos el usuario de los kwargs
        super().__init__(*args, **kwargs)

        if user:
            # Filtramos el queryset del campo 'category' para mostrar solo las del usuario actual.
            self.fields['category'].queryset = Category.objects.filter(user=user).order_by('name')
            # Filtramos el queryset del campo 'project' para mostrar solo los del usuario actual.
            self.fields['project'].queryset = Project.objects.filter(user=user).order_by('name')
        else:
            # Si no hay usuario (ej. en algún caso raro o si se usa sin contexto de usuario),
            # dejamos los querysets vacíos o podríamos mostrar todos si es un superadmin,
            # pero para la creación por usuario, el filtro es esencial.
            self.fields['category'].queryset = Category.objects.none()
            self.fields['project'].queryset = Project.objects.none()

        # Si el tipo de transacción es fijo a 'expense' y no quieres que el usuario lo vea/modifique
        # podrías ocultarlo o deshabilitarlo, pero al ser un ModelForm basado en `fields`,
        # se incluirá. Si solo quieres gastos, podrías quitar 'type' de `fields`
        # y asignarlo directamente en la vista antes de guardar.
        # Por ahora lo dejamos visible pero con default 'expense'.
        # self.fields['type'].disabled = True # Ejemplo si quisieras deshabilitarlo
        self.fields['type'].initial = 'expense'
```

---

## Archivo: `accounting/migrations/0001_initial.py`

```python
# Generated by Django 5.2 on 2025-05-10 15:41

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('tasks', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Category',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('user', models.ForeignKey(help_text='Usuario al que pertenece esta categoría', on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Categoría',
                'verbose_name_plural': 'Categorías',
                'unique_together': {('name', 'user')},
            },
        ),
        migrations.CreateModel(
            name='Transaction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.CharField(help_text='Descripción del gasto.', max_length=255)),
                ('amount', models.DecimalField(decimal_places=2, help_text='Monto del gasto.', max_digits=10)),
                ('transaction_date', models.DateField(default=django.utils.timezone.now, help_text='Fecha en que se realizó el gasto.')),
                ('type', models.CharField(choices=[('expense', 'Gasto')], default='expense', help_text='Tipo de transacción (actualmente solo Gasto).', max_length=10)),
                ('notes', models.TextField(blank=True, help_text='Notas adicionales sobre el gasto (opcional).', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('category', models.ForeignKey(blank=True, help_text='Categoría del gasto.', null=True, on_delete=django.db.models.deletion.SET_NULL, to='accounting.category')),
                ('project', models.ForeignKey(blank=True, help_text='Proyecto de TaskFlow al que está asociado este gasto (opcional).', null=True, on_delete=django.db.models.deletion.SET_NULL, to='tasks.project')),
                ('user', models.ForeignKey(help_text='Usuario que registró el gasto.', on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Transacción',
                'verbose_name_plural': 'Transacciones',
                'ordering': ['-transaction_date', '-created_at'],
            },
        ),
    ]

```

---

## Archivo: `accounting/migrations/__init__.py`

```python

```

---

## Archivo: `accounting/models.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\accounting\models.py

from django.db import models
from django.contrib.auth.models import User # Para asociar a un usuario
from tasks.models import Project # Para asociar a un proyecto de la app 'tasks'
from django.utils import timezone # Para la fecha por defecto

class Category(models.Model):
    """
    Representa una categoría para las transacciones (gastos/ingresos).
    Ejemplos: "Alimentación", "Transporte", "Materiales de Proyecto", "Software".
    """
    name = models.CharField(max_length=100, unique=True) # Nombre único para la categoría
    # El tipo podría ser útil si en el futuro quieres diferenciar categorías de Ingreso vs Egreso.
    # TYPE_CHOICES = [('expense', 'Gasto'), ('income', 'Ingreso')]
    # type = models.CharField(max_length=10, choices=TYPE_CHOICES, default='expense')
    user = models.ForeignKey(User, on_delete=models.CASCADE, help_text="Usuario al que pertenece esta categoría")
    # Opcional: para jerarquía de categorías
    # parent_category = models.ForeignKey('self', null=True, blank=True, on_delete=models.SET_NULL, related_name='subcategories')

    class Meta:
        verbose_name = "Categoría"
        verbose_name_plural = "Categorías"
        # Asegura que el nombre de la categoría sea único por usuario para evitar duplicados personales
        unique_together = ('name', 'user')


    def __str__(self):
        return f"{self.name} (Usuario: {self.user.username})"

class Transaction(models.Model):
    """
    Representa una transacción financiera, principalmente un gasto.
    Puede estar asociada a un proyecto específico o ser un gasto general/personal.
    """
    TRANSACTION_TYPE_CHOICES = [
        ('expense', 'Gasto'),
        # ('income', 'Ingreso'), # Podríamos añadir ingresos más adelante
    ]

    description = models.CharField(max_length=255, help_text="Descripción del gasto.")
    amount = models.DecimalField(max_digits=10, decimal_places=2, help_text="Monto del gasto.")
    transaction_date = models.DateField(default=timezone.now, help_text="Fecha en que se realizó el gasto.")
    
    type = models.CharField(
        max_length=10,
        choices=TRANSACTION_TYPE_CHOICES,
        default='expense',
        help_text="Tipo de transacción (actualmente solo Gasto)."
    )
    
    category = models.ForeignKey(
        Category, 
        on_delete=models.SET_NULL, # Si se borra la categoría, no borrar la transacción, solo desasociar
        null=True, 
        blank=True, # Permitir transacciones sin categorizar inicialmente
        help_text="Categoría del gasto."
    )
    project = models.ForeignKey(
        Project, 
        on_delete=models.SET_NULL, # Si se borra el proyecto, no borrar la transacción
        null=True, 
        blank=True, # El gasto puede no estar asociado a un proyecto (gasto personal)
        help_text="Proyecto de TaskFlow al que está asociado este gasto (opcional)."
    )
    user = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, # Si se borra el usuario, se borran sus transacciones
        help_text="Usuario que registró el gasto."
    )
    notes = models.TextField(blank=True, null=True, help_text="Notas adicionales sobre el gasto (opcional).")
    created_at = models.DateTimeField(auto_now_add=True) # Fecha de creación del registro
    updated_at = models.DateTimeField(auto_now=True)   # Fecha de última actualización

    class Meta:
        verbose_name = "Transacción"
        verbose_name_plural = "Transacciones"
        ordering = ['-transaction_date', '-created_at'] # Ordenar por fecha de transacción y luego por creación

    def __str__(self):
        return f"{self.description} - {self.amount} ({self.user.username})"
```

---

## Archivo: `accounting/templates/accounting/transaction_form.html`

```html
{# D:\trabajo\Propio\IA\programing\TaskFlow\accounting\templates\accounting\transaction_form.html #}
{% extends "tasks/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title|default:"Gestionar Transacción" }} - TaskFlow Contabilidad{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ page_title|default:"Gestionar Transacción" }}</h2>
    <hr>

    <form method="post" novalidate>
        {% csrf_token %}
        
        {# Esta es la única directiva que renderiza el cuerpo del formulario. #}
        {{ form|crispy }} 

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Guardar Transacción</button>
            <a href="{% url 'tasks:project_list' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block javascript %}
{{ super }}
{# Espacio para JavaScript específico de esta página si fuera necesario más adelante. #}
{# 
<script>
    // Ejemplo:
    // document.addEventListener('DOMContentLoaded', function() {
    //     var dateInput = document.querySelector('input[type="date"]');
    //     if (dateInput && dateInput.type !== 'date') { 
    //         dateInput.setAttribute('placeholder', 'AAAA-MM-DD');
    //     }
    // });
</script>
#}
{% endblock %}
```

---

## Archivo: `accounting/tests.py`

```python
from django.test import TestCase

# Create your tests here.

```

---

## Archivo: `accounting/urls.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\accounting\urls.py

from django.urls import path
from . import views # Importaremos las vistas de esta app

app_name = 'accounting' # Define un namespace para estas URLs

urlpatterns = [
    # URL para añadir una nueva transacción
    path('transaction/add/', views.transaction_create, name='transaction_create'),
    # Más adelante añadiremos la URL para listar transacciones aquí
    # path('transactions/', views.transaction_list, name='transaction_list'),
]
```

---

## Archivo: `accounting/views.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\accounting\views.py

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.urls import reverse_lazy # Para redirecciones después del éxito
from .forms import TransactionForm # Importamos nuestro nuevo formulario
from .models import Transaction # Importamos el modelo por si necesitamos interactuar directamente

@login_required # Solo usuarios logueados pueden acceder
def transaction_create(request):
    """
    Vista para manejar la creación de nuevas transacciones (gastos).
    """
    if request.method == 'POST':
        # Al instanciar el formulario con datos POST, pasamos el request.user
        # para que el __init__ del formulario pueda filtrar los querysets.
        form = TransactionForm(request.POST, user=request.user)
        if form.is_valid():
            # Creamos la instancia de la transacción pero sin guardarla aún (commit=False)
            transaction = form.save(commit=False)
            # Asignamos el usuario actual a la transacción
            transaction.user = request.user
            # Si el tipo es fijo y no está en el form, asignarlo aquí:
            # transaction.type = 'expense' # Aunque ya está en el form con default
            
            transaction.save() # Guardamos la transacción en la base de datos
            
            # Redirigir a alguna página después de guardar exitosamente.
            # Podría ser una lista de transacciones o de vuelta al dashboard.
            # Por ahora, vamos a asumir que tenemos una lista de transacciones más adelante.
            # Si no, podemos redirigir al dashboard de 'tasks'.
            # return redirect('accounting:transaction_list') # Cuando la tengamos
            return redirect(reverse_lazy('tasks:project_list')) # Redirige al dashboard principal por ahora
    else: # Si la solicitud es GET (o cualquier otro método)
        # Al instanciar el formulario vacío para una solicitud GET, también pasamos el request.user
        form = TransactionForm(user=request.user)

    # Renderizamos la plantilla, pasando el formulario.
    # Crearemos 'accounting/transaction_form.html' en el siguiente paso.
    context = {
        'form': form,
        'page_title': 'Registrar Nuevo Gasto' # Título para la plantilla
    }
    return render(request, 'accounting/transaction_form.html', context)

# Aquí iría la vista transaction_list más adelante
# @login_required
# def transaction_list(request):
#     transactions = Transaction.objects.filter(user=request.user)
#     context = {'transactions': transactions}
#     return render(request, 'accounting/transaction_list.html', context)
```

---

## Archivo: `manage.py`

```python
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'TaskFlowProject.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

```

---

## Archivo: `tasks/__init__.py`

```python

```

---

## Archivo: `tasks/admin.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\admin.py

from django.contrib import admin
from .models import Project, Task # Importamos nuestros modelos

# Registramos el modelo Project en el sitio de administración.
admin.site.register(Project)

# Registramos el modelo Task en el sitio de administración.
admin.site.register(Task)

# Opcional pero recomendado para mejor visualización:
# Podemos crear clases ModelAdmin para personalizar la apariencia en el admin.
# Esto refina la interfaz de control del sistema.

# class ProjectAdmin(admin.ModelAdmin):
#     list_display = ('name', 'user', 'created_at') # Campos a mostrar en la lista
#     search_fields = ('name', 'description') # Campos por los que se puede buscar

# class TaskAdmin(admin.ModelAdmin):
#     list_display = ('description', 'project', 'status', 'due_date', 'completed_at')
#     list_filter = ('status', 'project', 'due_date') # Filtros en la barra lateral
#     search_fields = ('description',)

# # Re-registramos usando las clases ModelAdmin personalizadas si las defines
# admin.site.register(Project, ProjectAdmin)
# admin.site.register(Task, TaskAdmin)
```

---

## Archivo: `tasks/apps.py`

```python
from django.apps import AppConfig


class TasksConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'tasks'

```

---

## Archivo: `tasks/forms.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\forms.py

from django import forms
# Importamos ambos modelos ahora, ya que ambos tendrán formularios asociados
from .models import Project, Task # <-- Asegúrate de importar Task

class ProjectForm(forms.ModelForm):
    """
    Formulario basado en el modelo Project para crear o actualizar proyectos.
    """
    class Meta:
        model = Project
        # Incluimos solo los campos que el usuario puede editar directamente
        fields = ['name', 'description']
        # Excluimos 'user' porque lo asignaremos automáticamente en la vista
        # Excluimos 'created_at' porque auto_now_add lo maneja
        # exclude = ['user', 'created_at'] # Esta sería otra forma de hacerlo
        
# NUEVO: Formulario para el modelo Task
class TaskForm(forms.ModelForm):
    """
    Formulario basado en el modelo Task para crear o actualizar tareas.
    """
    class Meta:
        model = Task
        # Listamos los campos del modelo Task que queremos incluir en el formulario.
        # 'description' y 'due_date' son los campos que el usuario introducirá.
        # Incluiremos 'status' para permitir al usuario establecer el estado inicial
        fields = ['description', 'status', 'due_date']
        # Excluimos 'project' porque lo asignaremos en la vista basándonos en la URL.
        # Excluimos 'created_at' y 'completed_at' porque se manejan automáticamente o en la lógica de la vista.
        # exclude = ['project', 'created_at', 'completed_at'] # Otra forma con exclude
```

---

## Archivo: `tasks/migrations/0001_initial.py`

```python
# Generated by Django 5.2 on 2025-05-07 02:06

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Project',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200)),
                ('description', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='Task',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.TextField()),
                ('status', models.CharField(choices=[('todo', 'Por hacer'), ('doing', 'En progreso'), ('done', 'Completada')], default='todo', max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('due_date', models.DateField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('project', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='tasks.project')),
            ],
        ),
    ]

```

---

## Archivo: `tasks/migrations/__init__.py`

```python

```

---

## Archivo: `tasks/models.py`

```python
from django.db import models
from django.contrib.auth.models import User # Importamos el modelo de usuario de Django

# Entidad Proyecto: El contenedor principal.
class Project(models.Model):
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True, null=True)
    # Relación: Un proyecto pertenece a UN usuario. Esta es una clave foránea.
    # on_delete=models.CASCADE: Si el usuario se elimina, también se eliminan sus proyectos.
    # Desde una perspectiva sistémica, define una fuerte dependencia existencial del Project con el User.
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True) # Captura la dinámica de creación

    # Método para representación legible del objeto (útil en la administración de Django)
    def __str__(self):
        return f"{self.name} (by {self.user.username})"

# Entidad Tarea: Lo que queremos gestionar, contenido dentro de un proyecto.
class Task(models.Model):
    # Opciones de estado: Definimos los estados posibles (parte de la dinámica del ciclo de vida de la tarea)
    STATUS_CHOICES = [
        ('todo', 'Por hacer'),
        ('doing', 'En progreso'),
        ('done', 'Completada'),
    ]

    description = models.TextField()
    # Campo de estado con opciones predefinidas. Define el comportamiento de estado de la tarea.
    status = models.CharField(max_length=10, choices=STATUS_CHOICES, default='todo')
    # Relación: Una tarea pertenece a UN proyecto. ¡Esta es la clave estructural de Opción 1!
    # on_delete=models.CASCADE: Si el proyecto se elimina, todas sus tareas también se eliminan.
    # Define la dependencia existencial de Task con Project.
    project = models.ForeignKey(Project, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    # Fecha de vencimiento: introduce la dimensión temporal y la dinámica de urgencia.
    due_date = models.DateField(null=True, blank=True)
    # Fecha de completado: registra un evento clave en la dinámica de la tarea.
    completed_at = models.DateTimeField(null=True, blank=True)

    # Método para representación legible del objeto
    def __str__(self):
        return f"{self.description[:50]}... (Status: {self.status})"

    # Opcional: Un método simple para cambiar el estado de forma controlada.
    # Encapsula parte de la lógica de negocio ("comportamiento").
    def mark_as_completed(self):
        if self.status != 'done':
            self.status = 'done'
            # Usa auto_now=True para actualizar la fecha y hora al guardar
            self.completed_at = models.DateTimeField(auto_now=True)
            self.save()
```

---

## Archivo: `tasks/services.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\services.py

# Importamos los modelos necesarios
from django.contrib.auth.models import User
from .models import Project, Task

# Importamos get_object_or_404 o manejaremos la excepción directamente en la vista
# Para estas funciones de servicio, es mejor que lancen excepciones si algo falla,
# y la vista que las llama se encargará de manejar esas excepciones y responder al usuario.
from django.shortcuts import get_object_or_404 # Puede ser útil aquí si queremos que la función encuentre el proyecto

# Si vas a manejar fechas de vencimiento, podrías necesitar esto:
# from django.utils import timezone
# from datetime import date # O date para campos DateField

def create_project_for_user(user_obj: User, name: str, description: str = None) -> Project:
    """
    Crea un nuevo objeto Project asociado a un usuario dado.
    Lanza una excepción si el usuario no es un objeto User válido o si falta el nombre.
    """
    if not isinstance(user_obj, User):
        raise ValueError("Invalid user object provided.")
    if not name:
        raise ValueError("Project name cannot be empty.")

    # Creamos y guardamos la instancia del Project
    # Django asignará user y created_at automáticamente si los campos están configurados así
    project = Project(user=user_obj, name=name, description=description)
    project.save()

    # Devolvemos el objeto Project recién creado
    print(f"DEBUG: Project '{name}' created for user {user_obj.username}") # Log de depuración
    return project

def create_task_for_project(project_obj: Project, description: str, status: str = 'todo', due_date=None) -> Task:
    """
    Crea un nuevo objeto Task asociado a un proyecto dado.
    project_obj debe ser una instancia válida de Project.
    Lanza una excepción si el proyecto o la descripción no son válidos.
    """
    if not isinstance(project_obj, Project):
        raise ValueError("Invalid project object provided.")
    if not description:
        raise ValueError("Task description cannot be empty.")

    # Puedes añadir validación básica para status si quieres,
    # aunque el modelo ya tiene choices y default.
    # if status not in [choice[0] for choice in Task.STATUS_CHOICES]:
    #     status = 'todo' # O lanzar un error

    # Puedes intentar parsear la fecha si due_date no es un objeto date/None
    # if due_date and not isinstance(due_date, date):
    #     try:
    #         # Implementar lógica para parsear la fecha si viene como string,
    #         # dependiendo de cómo la API de Gemini la devuelva.
    #         # Por ahora, asumimos que due_date es None o un objeto date válido.
    #         pass # Aquí iría la lógica de parseo de fecha
    #     except ValueError:
    #         due_date = None # O lanzar un error indicando fecha inválida


    # Creamos y guardamos la instancia de la Task
    task = Task(project=project_obj, description=description, status=status, due_date=due_date)
    task.save()

    # Devolvemos el objeto Task recién creado
    print(f"DEBUG: Task '{description[:20]}...' created for project '{project_obj.name}'") # Log de depuración
    return task

# Opcional: Una función para encontrar un proyecto por nombre y usuario (será llamada por la vista, no directamente por Gemini)
def get_project_by_user_and_name(user_obj: User, project_name: str) -> Project:
     """
     Busca un proyecto por nombre para un usuario específico.
     Lanza Project.DoesNotExist o Project.MultipleObjectsReturned si no se encuentra o hay duplicados.
     """
     if not isinstance(user_obj, User):
         raise ValueError("Invalid user object provided.")
     if not project_name:
         raise ValueError("Project name cannot be empty for lookup.")

     # Usamos get_object_or_404 (aunque el nombre es get_object_or_404, aquí lanza DoesNotExist/MultipleObjectsReturned)
     # Filtramos por usuario Y nombre
     return get_object_or_404(Project, user=user_obj, name=project_name)
```

---

## Archivo: `tasks/templates/tasks/base.html`

```html
{# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\templates\tasks\base.html #}
<!DOCTYPE html>
<html lang="es">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TaskFlow{% endblock %}</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: #f8f9fa; 
            color: #212529;
            line-height: 1.6;
        }
        .header { 
            background-color: #343a40; 
            color: white; 
            padding: 1rem 2rem; 
            margin-bottom: 2rem;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 2.5rem; }
        .header a { color: white; text-decoration: none; }

        .nav {
            background-color: #495057;
            padding: 0.5rem 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .nav a {
            color: #f8f9fa;
            margin: 0 15px;
            text-decoration: none;
            font-weight: 500;
        }
        .nav a:hover {
            color: #adb5bd;
        }

        .container { 
            width: 90%; 
            max-width: 1200px;
            margin: 0 auto; 
            padding: 20px; 
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.075);
        }
        /* Estilos para la consola de IA y la lista de proyectos (se pueden mover a project_list.html si se prefiere) */
        textarea#instruction { width: 98%; padding: 10px; margin-bottom: 10px; border: 1px solid #ced4da; border-radius: 4px; min-height: 60px; font-size: 1rem; }
        button[type="submit"] { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button[type="submit"]:hover { background-color: #0056b3; }
        #responseArea { margin-top: 15px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px; background-color: #e9ecef; min-height: 40px; white-space: pre-wrap; font-family: monospace; }
        .loading { color: #007bff; }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }

        h1, h2, h3 { color: #343a40; }
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 0.5em; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Clases para proyectos y tareas */
        .project-list-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .project-list-item h3 { margin-top: 0; }
        .project-list-item h3 a { color: #0056b3; }
        .task-list { margin-left: 20px; margin-top: 10px; }
        .task-list-item {
            padding: 5px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        .task-list-item:last-child { border-bottom: none; }

    </style>
</head>
<body>
    <header class="header">
        <h1><a href="{% url 'tasks:project_list' %}">TaskFlow</a></h1>
    </header>

    <nav class="nav">
        <a href="{% url 'accounting:transaction_create' %}">Registrar Gasto</a>
        <a href="{% url 'tasks:project_list' %}">Mis Proyectos / Dashboard</a>
        {# Si aún queremos los formularios manuales fácilmente accesibles #}
        <a href="{% url 'tasks:project_create' %}">Crear Proyecto (Manual)</a>
        
        {% if user.is_authenticated %}
            <span style="color: #adb5bd;">Hola, {{ user.username }}!</span>
            {# Aquí podrías añadir un enlace para cerrar sesión, Django maneja la URL /admin/logout/
               o podrías definir tu propia vista y URL de logout si no usas la del admin.
               Por ahora, lo dejamos así, el logout se puede hacer desde /admin/logout/ #}
        {% else %}
            {# Enlace a login, Django redirige automáticamente si se accede a una vista @login_required
               pero podrías querer un enlace explícito. La URL de login suele ser /admin/login/ o la que configures. #}
        {% endif %}
    </nav>

    <main class="container">
        {% block content %}
        {# El contenido específico de cada página irá aquí #}
        {% endblock %}
    </main>

    <footer>
        {# Podrías añadir un pie de página si lo deseas #}
    </footer>

    {% block javascript %}
    {# Espacio para JavaScript específico de cada página, si es necesario además del de la consola de IA #}
    {% endblock %}
</body>
</html>
```

---

## Archivo: `tasks/templates/tasks/project_detail.html`

```html
{# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\templates\tasks\project_detail.html #}
<!DOCTYPE html>
<html>
<head>
    <title>{{ project.name }} - Tareas</title>
</head>
<body>
    <h1>{{ project.name }}</h1>
    <p>{{ project.description }}</p>

    <h2>Tareas</h2>
      <p><a href="{% url 'tasks:task_create' project_pk=project.pk %}">Añadir Nueva Tarea</a></p> {# <-- Añade esta línea #}

    {% if tasks %}
        <ul>
            {% for task in tasks %}
                <li>
                    {{ task.description }} (Estado: {{ task.get_status_display }})
                    {% if task.due_date %} - Vence: {{ task.due_date }}{% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Este proyecto aún no tiene tareas.</p>
         <p><a href="{% url 'tasks:task_create' project_pk=project.pk %}">Añadir la primera tarea a este proyecto</a></p>
    {% endif %}

    <p><a href="{% url 'tasks:project_list' %}">Volver a la lista de proyectos</a></p>

</body>
</html>
```

---

## Archivo: `tasks/templates/tasks/project_form.html`

```html
{# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\templates\tasks\project_form.html #}
<!DOCTYPE html>
<html>
<head>
    <title>Crear Nuevo Proyecto</title>
    <style>
        .errorlist {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Crear Nuevo Proyecto</h1>

    <form method="post" action="{% url 'tasks:project_create' %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Guardar Proyecto</button>
    </form>

    <p><a href="{% url 'tasks:project_list' %}">Cancelar y volver a la lista</a></p>

</body>
</html>
```

---

## Archivo: `tasks/templates/tasks/project_list.html`

```html
{# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\templates\tasks\project_list.html #}
{% extends "tasks/base.html" %}

{% block title %}Dashboard - Mis Proyectos{% endblock %}

{% block content %}
    {# Sección de la Consola de IA (anteriormente en ai_console.html) #}
    <section id="ai-console-section" style="margin-bottom: 30px; padding: 20px; background-color: #e9f7fd; border-radius: 5px;">
        <h2>Crear con IA</h2>
        <p style="font-size: 0.9em; color: #555;">
            Usa lenguaje natural para crear proyectos y tareas. Ejemplos:<br>
            <em>"Crear proyecto 'Rediseño Web' con descripción 'Actualizar el sitio principal'."</em><br>
            <em>"Añadir tarea 'Diseñar wireframes' al proyecto 'Rediseño Web' para el 2025-06-15."</em>
        </p>

        <form id="aiCommandForm">
            {% csrf_token %}
            <div>
                <textarea id="instruction" name="instruction" rows="3" placeholder="Escribe tu instrucción aquí..." required></textarea>
            </div>
            <button type="submit">Enviar a IA</button>
        </form>
        <div id="responseArea">
            Esperando instrucción...
        </div>
    </section>
    {# Fin Sección de la Consola de IA #}

    <hr style="margin: 30px 0;">

    {# Sección de Listado de Proyectos #}
    <section id="projects-section">
        <h2>Mis Proyectos</h2>

        {% if projects %}
            <ul class="project-list">
                {% for project in projects %}
                    <li class="project-list-item">
                        <h3>
                            {# Enlace al detalle del proyecto. Si decides no tener página de detalle separada, esto podría cambiar #}
                            <a href="{% url 'tasks:project_detail' pk=project.pk %}">{{ project.name }}</a>
                        </h3>
                        {% if project.description %}
                            <p style="font-size: 0.9em; color: #6c757d;">{{ project.description }}</p>
                        {% endif %}
                        
                        <h4>Tareas:</h4>
                        {% if project.task_set.all %} {# Obtenemos las tareas directamente aquí #}
                            <ul class="task-list">
                                {% for task in project.task_set.all %}
                                    <li class="task-list-item">
                                        {{ task.description }} 
                                        <span style="font-size: 0.8em; color: #6c757d;">
                                            (Estado: {{ task.get_status_display }})
                                            {% if task.due_date %} - Vence: {{ task.due_date|date:"d M Y" }}{% endif %}
                                        </span>
                                        {# Aquí podrías añadir enlaces para editar/completar tarea si implementas esa funcionalidad #}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p style="font-size: 0.9em; color: #6c757d;">Este proyecto aún no tiene tareas.</p>
                        {% endif %}
                        {# Enlace para añadir tarea manualmente (si aún lo queremos visible) #}
                        {# Podríamos quitarlo si la IA es el método principal de creación de tareas #}
                        <p style="margin-top:10px;"><a href="{% url 'tasks:task_create' project_pk=project.pk %}" style="font-size:0.9em;">Añadir Tarea (Manual)</a></p>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Aún no tienes proyectos. ¡Usa la consola de IA arriba para crear uno!</p>
        {% endif %}
    </section>
    {# Fin Sección de Listado de Proyectos #}
{% endblock %}

{% block javascript %}
{# JavaScript para la consola de IA (anteriormente en ai_console.html) #}
<script>
    document.addEventListener('DOMContentLoaded', function() { // Asegura que el DOM esté cargado
        const aiCommandForm = document.getElementById('aiCommandForm');
        if (aiCommandForm) {
            aiCommandForm.addEventListener('submit', async function(event) {
                event.preventDefault(); 

                const instructionText = document.getElementById('instruction').value;
                const responseArea = document.getElementById('responseArea');
                const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                
                if (!csrfTokenInput) {
                    console.error('CSRF token not found!');
                    responseArea.innerHTML = '<p class="error">Error de configuración: Falta el token CSRF.</p>';
                    return;
                }
                const csrfToken = csrfTokenInput.value;

                responseArea.innerHTML = '<p class="loading">Procesando tu instrucción...</p>';
                document.getElementById('instruction').value = ''; // Limpiar el textarea después de enviar

                try {
                    const response = await fetch("{% url 'tasks:ai_command_handler' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ instruction: instructionText })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        let htmlResponse = `<p class="success"><strong>${data.message || 'Operación completada.'}</strong></p>`;
                        if (data.type === 'project_created' && data.project_id) {
                            htmlResponse += `<p>ID del Proyecto: ${data.project_id}</p>`;
                            // Podríamos forzar una recarga de la página para ver el nuevo proyecto, o añadirlo dinámicamente con más JS
                            // window.location.reload(); // Opción simple para ver el cambio
                        } else if (data.type === 'task_created' && data.task_id) {
                            htmlResponse += `<p>ID de la Tarea: ${data.task_id}</p>`;
                            // window.location.reload(); // Opción simple para ver el cambio
                        }
                        responseArea.innerHTML = htmlResponse;
                        
                        // Si la operación fue exitosa y afectó la lista (proyecto/tarea creada),
                        // recargar la página para ver los cambios es una forma simple de actualizar.
                        // Una solución más avanzada sería actualizar el DOM dinámicamente.
                        if (data.type === 'project_created' || data.type === 'task_created') {
                            setTimeout(() => { window.location.reload(); }, 1500); // Recarga después de 1.5 segundos
                        }

                    } else {
                        responseArea.innerHTML = `<p class="error"><strong>Error:</strong> ${data.error || 'Ocurrió un error desconocido.'}</p>`;
                    }

                } catch (error) {
                    console.error('Error en la solicitud AI:', error);
                    responseArea.innerHTML = `<p class="error"><strong>Error de conexión o en el script:</strong> ${error.message}</p>`;
                }
            });
        }
    });
</script>
{% endblock %}
```

---

## Archivo: `tasks/templates/tasks/task_form.html`

```html
{# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\templates\tasks\task_form.html #}
<!DOCTYPE html>
<html>
<head>
    <title>Añadir Tarea a {{ project.name }}</title>
    <style>
        .errorlist {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Añadir Tarea a Proyecto: "{{ project.name }}"</h1>

    <form method="post" action="{% url 'tasks:task_create' project_pk=project.pk %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Guardar Tarea</button>
    </form>

    <p><a href="{% url 'tasks:project_detail' pk=project.pk %}">Cancelar y volver al proyecto</a></p>

</body>
</html>
```

---

## Archivo: `tasks/tests.py`

```python
from django.test import TestCase

# Create your tests here.

```

---

## Archivo: `tasks/urls.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\urls.py

from django.urls import path
from . import views

# Namespace para evitar colisiones de nombres de URL si tienes muchas apps
app_name = 'tasks'

urlpatterns = [
    # URL para la lista de proyectos
    path('projects/', views.project_list, name='project_list'),

    # URL para crear un nuevo proyecto
    path('projects/new/', views.project_create, name='project_create'),

    # URL para ver los detalles de un proyecto específico
    path('projects/<int:pk>/', views.project_detail, name='project_detail'),

    # URL para crear una nueva tarea dentro de un proyecto específico
    path('projects/<int:project_pk>/tasks/new/', views.task_create, name='task_create'),

    # URL para el endpoint de comandos de IA (API)
    path('ai-command/', views.ai_command_handler, name='ai_command_handler'),
]
```

---

## Archivo: `tasks/views.py`

```python
# D:\trabajo\Propio\IA\programing\TaskFlow\tasks\views.py

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.http import JsonResponse # Para devolver respuestas JSON
from django.views.decorators.csrf import csrf_exempt # Para deshabilitar CSRF si se prueba con herramientas externas (ver nota)
from django.views.decorators.http import require_POST # Para asegurar que solo sea POST
import json # Para parsear el cuerpo de la solicitud JSON
import os # Para obtener la clave de API

# Importaciones de Gemini
import google.generativeai as genai # Importa la biblioteca de Gemini
from google.generativeai.types import HarmCategory, HarmBlockThreshold # Para configurar seguridad

from .models import Project, Task
from .forms import ProjectForm, TaskForm
# Importamos nuestras funciones de servicio
from .services import create_project_for_user, create_task_for_project, get_project_by_user_and_name

# Decorador para asegurar que solo usuarios autenticados puedan acceder a estas vistas.
# tasks/views.py - extracto de la vista project_list actualizada

@login_required
def project_list(request):
    """
    Vista para listar todos los proyectos pertenecientes al usuario autenticado,
    incluyendo sus tareas precargadas para eficiencia.
    """
    # Usamos prefetch_related para obtener todas las tareas asociadas
    # a los proyectos en una consulta adicional eficiente, en lugar de una por proyecto.
    projects = Project.objects.filter(user=request.user).prefetch_related('task_set').order_by('name')
    context = {
        'projects': projects
        # 'ai_console_url_name': 'tasks:ai_command_handler' # Ya no es necesario si el form está aquí
    }
    return render(request, 'tasks/project_list.html', context)

@login_required
def project_detail(request, pk):
    """
    Vista para mostrar los detalles de un proyecto específico y sus tareas asociadas.
    Solo muestra proyectos que pertenecen al usuario autenticado.
    """
    project = get_object_or_404(Project, pk=pk, user=request.user)
    tasks = project.task_set.all().order_by('due_date', 'created_at')
    context = {
        'project': project,
        'tasks': tasks
    }
    return render(request, 'tasks/project_detail.html', context)

@login_required
def project_create(request):
    """
    Vista para manejar la creación de nuevos proyectos.
    Responde a GET mostrando el formulario y a POST procesando los datos.
    """
    if request.method == 'POST':
        form = ProjectForm(request.POST)
        if form.is_valid():
            project = form.save(commit=False)
            project.user = request.user
            project.save()
            return redirect('tasks:project_list')
    else:
        form = ProjectForm()

    return render(request, 'tasks/project_form.html', {'form': form})

@login_required
def task_create(request, project_pk):
    """
    Vista para manejar la creación de nuevas tareas dentro de un proyecto específico.
    """
    project = get_object_or_404(Project, pk=project_pk, user=request.user)
    if request.method == 'POST':
        form = TaskForm(request.POST)
        if form.is_valid():
            task = form.save(commit=False)
            task.project = project
            task.save()
            return redirect('tasks:project_detail', pk=project.pk)
    else:
        form = TaskForm()
    return render(request, 'tasks/task_form.html', {'form': form, 'project': project})


# Definición de las funciones para Gemini
GEMINI_FUNCTION_DECLARATIONS = [
    {
        "name": "create_project",
        "description": "Crea un nuevo proyecto para el usuario. Útil cuando el usuario quiere iniciar un nuevo proyecto, plan o contenedor de tareas.",
        "parameters": {
            "type": "OBJECT", # Indica que los parámetros son un objeto con propiedades
            "properties": {
                "name": {
                    "type": "STRING",
                    "description": "El nombre del proyecto."
                },
                "description": {
                    "type": "STRING",
                    "description": "Una descripción detallada del proyecto (opcional)."
                }
            },
            "required": ["name"] # Indica qué propiedades son obligatorias
        }
    },
    {
        "name": "create_task",
        "description": "Crea una nueva tarea y la asigna a un proyecto existente del usuario. Útil cuando el usuario quiere añadir una nueva tarea, ítem por hacer, o acción a un proyecto.",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "project_name": {
                    "type": "STRING",
                    "description": "El nombre del proyecto al que pertenece la tarea."
                },
                "description": {
                    "type": "STRING",
                    "description": "La descripción de la tarea a realizar."
                },
                "status": {
                    "type": "STRING",
                    "description": "El estado actual de la tarea. Valores permitidos: 'todo', 'doing', 'done'. Por defecto es 'todo' si no se especifica.",
                    "enum": ["todo", "doing", "done"] # Ayuda a Gemini a restringir los valores
                },
                "due_date": {
                    "type": "STRING",
                    "description": "La fecha de vencimiento de la tarea en formato AAAA-MM-DD (opcional)."
                }
            },
            "required": ["project_name", "description"]
        }
    }
]

# Nota sobre CSRF:
# Si vas a probar este endpoint desde una herramienta externa (como Postman)
# que no envía automáticamente el token CSRF, puedes usar @csrf_exempt temporalmente.
# Para un frontend web con JavaScript, asegúrate de incluir el token CSRF en tus solicitudes AJAX.
# @csrf_exempt # Descomentar SOLO para pruebas con herramientas externas si es necesario.


@login_required # Asegura que el usuario esté autenticado
@require_POST # Asegura que este endpoint solo acepte solicitudes POST
def ai_command_handler(request):
    try:
        # 1. Obtener la clave de API de forma segura
        api_key = os.getenv('GOOGLE_API_KEY')
        if not api_key:
            print("ERROR: GOOGLE_API_KEY no encontrada en el entorno.")
            return JsonResponse({'error': 'API Key no configurada en el servidor.'}, status=500)
        genai.configure(api_key=api_key)

        # 2. Parsear la instrucción del usuario desde el cuerpo de la solicitud JSON
        try:
            data = json.loads(request.body)
            user_instruction = data.get('instruction')
        except json.JSONDecodeError:
            return JsonResponse({'error': 'Cuerpo de la solicitud JSON inválido o vacío.'}, status=400)


        if not user_instruction:
            return JsonResponse({'error': 'Instrucción no proporcionada.'}, status=400)

        # 3. Preparar el modelo Gemini con las herramientas (nuestras funciones)
        # Consulta la documentación de Gemini para el nombre exacto del modelo recomendado.
        model = genai.GenerativeModel(
            model_name='gemini-1.5-flash-latest', # O 'gemini-1.0-pro', etc.
            tools=GEMINI_FUNCTION_DECLARATIONS,
            safety_settings={ # Configuración de seguridad básica
                HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_NONE,
                HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_NONE,
                HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_NONE,
                HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE,
            }
        )
        # Iniciamos una sesión de chat. enable_automatic_function_calling=False para control manual.
        chat = model.start_chat(enable_automatic_function_calling=False)

        # 4. Enviar la instrucción del usuario a Gemini
        print(f"DEBUG: [AI Handler] Enviando a Gemini: '{user_instruction}' para el usuario {request.user.username}")
        response = chat.send_message(user_instruction)
        
        # 5. Procesar la respuesta de Gemini para llamadas a función
        # Accedemos a la primera parte del primer candidato (puede haber varios candidatos)
        if not response.candidates or not response.candidates[0].content.parts:
            print(f"DEBUG: [AI Handler] Respuesta de Gemini inesperada o vacía: {response.prompt_feedback}")
            # Si el prompt fue bloqueado, prompt_feedback puede dar información.
            if response.prompt_feedback and response.prompt_feedback.block_reason:
                 return JsonResponse({'error': f'La instrucción fue bloqueada por seguridad: {response.prompt_feedback.block_reason_message}'}, status=400)
            return JsonResponse({'message': response.text if hasattr(response, 'text') else 'No se pudo obtener una respuesta clara de la IA.'})

        # Intentar acceder a function_call
        try:
            function_call_part = response.candidates[0].content.parts[0]
            if hasattr(function_call_part, 'function_call'):
                function_call = function_call_part.function_call
            else:
                function_call = None # No es una llamada a función
        except IndexError:
             print(f"DEBUG: [AI Handler] No se encontraron 'parts' en la respuesta de Gemini.")
             return JsonResponse({'message': response.text if hasattr(response, 'text') else 'Respuesta de IA sin partes procesables.'})


        if function_call:
            function_name = function_call.name
            args = function_call.args
            args_dict = {key: value for key, value in args.items()}

            print(f"DEBUG: [AI Handler] Gemini quiere llamar a '{function_name}' con args: {args_dict}")

            if function_name == "create_project":
                project_name = args_dict.get("name")
                description = args_dict.get("description") # Puede ser None
                if not project_name:
                    # (Opcional) Aquí podrías volver a llamar a Gemini pidiendo el nombre
                    return JsonResponse({'error': "Gemini no proporcionó un nombre para el proyecto."}, status=400)
                
                try:
                    project = create_project_for_user(request.user, project_name, description)
                    final_user_message = f"Proyecto '{project.name}' creado exitosamente."
                    print(f"INFO: [AI Handler] {final_user_message}")
                    return JsonResponse({'message': final_user_message, 'project_id': project.id, 'type': 'project_created'})
                except ValueError as e:
                    print(f"ERROR: [AI Handler] Error al crear proyecto: {str(e)}")
                    return JsonResponse({'error': f"Error al crear proyecto: {str(e)}"}, status=400)

            elif function_name == "create_task":
                project_name_for_task = args_dict.get("project_name")
                task_description = args_dict.get("description")
                status = args_dict.get("status", "todo") 
                due_date_str = args_dict.get("due_date")

                if not project_name_for_task or not task_description:
                    return JsonResponse({'error': "Gemini no proporcionó nombre de proyecto o descripción de tarea."}, status=400)

                try:
                    project_obj = get_project_by_user_and_name(request.user, project_name_for_task)
                    
                    parsed_due_date = None
                    if due_date_str:
                        try:
                            from datetime import datetime # Importación local
                            parsed_due_date = datetime.strptime(due_date_str, "%Y-%m-%d").date()
                        except ValueError:
                            print(f"WARN: [AI Handler] Formato de fecha inválido '{due_date_str}' recibido de Gemini. Se ignorará la fecha.")
                            # Podrías informar al usuario que la fecha no se pudo parsear
                            # O intentar preguntarle de nuevo a Gemini por una fecha válida.
                            pass # Se usará None

                    task = create_task_for_project(project_obj, task_description, status, parsed_due_date)
                    final_user_message = f"Tarea '{task.description[:30]}...' añadida al proyecto '{project_obj.name}'."
                    print(f"INFO: [AI Handler] {final_user_message}")
                    return JsonResponse({'message': final_user_message, 'task_id': task.id, 'type': 'task_created'})
                except Project.DoesNotExist:
                    print(f"WARN: [AI Handler] Proyecto '{project_name_for_task}' no encontrado para {request.user.username}.")
                    return JsonResponse({'error': f"El proyecto '{project_name_for_task}' no fue encontrado. ¿Quizás quisiste decir otro nombre o necesitas crearlo primero?"}, status=404)
                except ValueError as e:
                    print(f"ERROR: [AI Handler] Error al crear tarea: {str(e)}")
                    return JsonResponse({'error': f"Error al crear tarea: {str(e)}"}, status=400)
            
            else:
                print(f"WARN: [AI Handler] Función desconocida solicitada por Gemini: {function_name}")
                return JsonResponse({'error': f"Función desconocida solicitada por Gemini: {function_name}"}, status=400)
        else:
            # Si Gemini no devuelve una llamada a función, devolvemos su texto.
            print(f"DEBUG: [AI Handler] Gemini respondió con texto: '{response.text if hasattr(response, 'text') else 'Respuesta vacía'}'")
            return JsonResponse({'message': response.text if hasattr(response, 'text') else 'La IA no sugirió una acción específica.'})

    except Exception as e:
        # Captura general de errores para depuración
        import traceback # Para obtener más detalles del error
        print(f"CRITICAL ERROR en ai_command_handler: {type(e).__name__} - {str(e)}")
        print(traceback.format_exc()) # Imprime el stack trace completo del error
        return JsonResponse({'error': 'Ocurrió un error inesperado y crítico en el servidor.'}, status=500)
    

```

---

